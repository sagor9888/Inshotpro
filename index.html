<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FutureStore- User Panel</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDGG-Y89QFbsJ175MRp-WK2Uz_w89ZNxp0",
          authDomain: "sagor-de75b.firebaseapp.com",
          databaseURL: "https://sagor-de75b-default-rtdb.firebaseio.com",
          projectId: "sagor-de75b",
          storageBucket: "sagor-de75b.firebasestorage.app",
          messagingSenderId: "1070587352621",
          appId: "1:1070587352621:web:98462ec689723dcdb48aa4",
          measurementId: "G-MDY6LGX8SC"
        };

        const telegramBotToken = "7848617356:AAEASLrrtpy-Pv1_QRmh52fhwBPSscKF-Bk";
        const imgbbApiKey = "dd4fca7c33e5552bf5989ef3ad9ac922";
    </script>
    <script> let auth; let db; </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;700&family=Open+Sans:wght@300;400;700&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-bg: #F5F5F7; --secondary-bg: #FFFFFF;
            --primary-text: #1D1D1F; --secondary-text: #6e6e73;
            --accent-color: #007AFF; --accent-glow: rgba(0, 122, 255, 0.4);
            --border-color: #D2D2D7; --header-bg: rgba(245, 245, 247, 0.85);
            --star-color: #FF9500; --success-color: #34C759; --error-color: #FF3B30;
            --pending-color: #FF9500;
            --font-display: 'Orbitron', sans-serif;
        }
        body.dark-theme {
            --primary-bg: #161616; --secondary-bg: #212121;
            --primary-text: #E0E0E0; --secondary-text: #888;
            --accent-color: #00E5FF; --accent-glow: rgba(0, 229, 255, 0.7);
            --border-color: #2F2F2F; --header-bg: rgba(22, 22, 22, 0.85);
            --star-color: #FFC107; --success-color: #00C853; --error-color: #FF5252;
            --pending-color: #FFC107;
        }
        body[data-font="Roboto"] { --font-body: 'Roboto', sans-serif; }
        body[data-font="Lato"] { --font-body: 'Lato', sans-serif; }
        body[data-font="Montserrat"] { --font-body: 'Montserrat', sans-serif; }
        body[data-font="Open Sans"] { --font-body: 'Open Sans', sans-serif; }
        body[data-font="Source Code Pro"] { --font-body: 'Source Code Pro', monospace; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { font-size: 16px; }
        body { background-color: var(--primary-bg); color: var(--primary-text); font-family: var(--font-body); overscroll-behavior-y: contain; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        .hidden { display: none !important; }
        .icon-btn i, .nav-link i { margin-right: 12px; width: 20px; text-align: center; }
        #auth-wall { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 2000; transition: opacity 0.5s ease; }
        #auth-container { width: 90%; max-width: 400px; padding: 30px; background-color: var(--secondary-bg); border-radius: 20px; border: 1px solid var(--border-color); box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; }
        .dark-theme #auth-container { box-shadow: 0 0 40px rgba(0, 229, 255, 0.1); }
        .auth-title { font-family: var(--font-display); font-size: 2rem; color: var(--accent-color); text-align: center; margin-bottom: 25px; }
        .auth-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .auth-tab-btn { flex: 1; padding: 15px; background: none; border: none; font-size: 1rem; font-weight: bold; color: var(--secondary-text); cursor: pointer; position: relative; transition: color .2s ease; }
        .auth-tab-btn.active { color: var(--accent-color); }
        .auth-tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background-color: var(--accent-color); }
        .auth-form { display: none; animation: fadeIn 0.5s; }
        .auth-form.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #theme-toggle-btn .sun-icon { display: none; } #theme-toggle-btn .moon-icon { display: block; }
        .dark-theme #theme-toggle-btn .sun-icon { display: block; } .dark-theme #theme-toggle-btn .moon-icon { display: none; }
        #skeleton-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--primary-bg); z-index: 2000; display: flex; flex-direction: column; animation: fadeIn 0.5s; }
        .skeleton-full-content { width: 100%; flex-grow: 1; padding: 15px; }
        .skeleton-top-bar { display: flex; align-items: center; height: 65px; margin-bottom: 20px; }
        .skeleton-menu-btn { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(90deg, var(--border-color) 25%, var(--secondary-text) 50%, var(--border-color) 75%); background-size: 200% 100%; animation: loading-pulse 1.5s infinite; margin-right: 15px; }
        .skeleton-title-bar { flex-grow: 1; height: 30px; background: linear-gradient(90deg, var(--border-color) 25%, var(--secondary-text) 50%, var(--border-color) 75%); background-size: 200% 100%; animation: loading-pulse 1.5s infinite; border-radius: 8px; }
        .skeleton-grid-section { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; width: 100%; }
        .skeleton-grid-item { height: 180px; background: linear-gradient(90deg, var(--border-color) 25%, var(--secondary-text) 50%, var(--border-color) 75%); background-size: 200% 100%; animation: loading-pulse 1.5s infinite; border-radius: 12px; }
        @keyframes loading-pulse { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 20px; animation: fadeIn 0.3s ease; }
        .modal-container { background-color: var(--secondary-bg); width: 100%; max-width: 450px; border-radius: 16px; border: 1px solid var(--border-color); max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h2 { font-family: var(--font-display); font-size: 1.2rem; color: var(--accent-color); margin: 0; }
        .modal-content { padding: 20px; overflow-y: auto; line-height: 1.6; }
        .close-modal-btn { background: none; border: none; font-size: 1.8rem; color: var(--secondary-text); cursor: pointer; line-height: 1; padding: 0 5px; }
        .notification-container { max-width: 350px; text-align: center; }
        .notification-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }
        .notification-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .notification-btn.primary { background-color: var(--accent-color); color: var(--secondary-bg); }
        .dark-theme .notification-btn.primary { color: #000; }
        .notification-btn.secondary { background-color: var(--border-color); color: var(--primary-text); }
        .form-input { width: 100%; padding: 15px; margin-bottom: 15px; background-color: var(--primary-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text); font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-glow); }
        .form-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background-color: var(--accent-color); color: var(--secondary-bg); font-size: 1.1rem; font-weight: bold; cursor: pointer; position: relative; overflow: hidden; transition: background-color 0.3s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .dark-theme .form-btn { color: #000; }
        .form-btn.loading { color: transparent !important; }
        .form-btn.loading::after { content: ''; position: absolute; width: 24px; height: 24px; top: 50%; left: 50%; margin-top: -12px; margin-left: -12px; border: 3px solid rgba(255,255,255,0.5); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }
        .dark-theme .form-btn.loading::after { border: 3px solid rgba(0,0,0,0.5); border-top-color: #000; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .form-btn.success { background-color: var(--success-color); color: white !important; }
        #screenshot-viewer img { max-width: 90vw; max-height: 80vh; object-fit: contain; }
        .screenshot-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.3); color: #fff; border: none; font-size: 2rem; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .screenshot-nav:hover { background: rgba(0,0,0,0.5); }
        .screenshot-nav.prev { left: 20px; } .screenshot-nav.next { right: 20px; }
        #screenshot-viewer .close-modal-btn { position: absolute; top: 10px; right: 10px; color: #fff; text-shadow: 0 0 5px #000; }
        .profile-pic-editor { text-align: center; margin-bottom: 20px; }
        #profile-pic-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); margin: 0 auto 10px; background-color: var(--border-color); display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; }
        #profile-pic-preview.has-image { background-color: transparent; }
        #profile-pic-preview .default-profile-icon { font-size: 50px; color: var(--primary-text); }
        #change-pic-btn { background: none; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .dropdown-menu { position: absolute; top: 60px; right: 15px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 101; overflow: hidden; animation: fadeIn 0.2s ease; }
        .dropdown-menu a { display: block; padding: 12px 20px; color: var(--primary-text); text-decoration: none; }
        .dropdown-menu a:hover { background-color: var(--primary-bg); }
        .dropdown-menu a.active { color: var(--accent-color); font-weight: bold; }
        #main-content { height: 100vh; display: flex; flex-direction: column; }
        #main-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); position: fixed; width: 100%; top: 0; z-index: 100; background-color: var(--header-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        #header-title { font-family: var(--font-display); font-size: 1.4rem; color: var(--accent-color); }
        .header-actions { display: flex; align-items: center; gap: 5px; }
        .icon-btn { background: none; border: none; color: var(--primary-text); cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; font-size: 1.1rem; }
        .icon-btn:hover, .icon-btn.active { background-color: var(--border-color); }
        #side-drawer { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: var(--primary-bg); z-index: 1100; border-right: 1px solid var(--border-color); transition: left 0.3s ease-in-out; display: flex; flex-direction: column; justify-content: space-between; }
        #side-drawer.open { left: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
        #drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1099; display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #drawer-overlay.visible { display: block; opacity: 1; }
        .drawer-content { overflow-y: auto; }
        .drawer-profile-section { padding: 20px; text-align: center; }
        .profile-pic-container { width: 80px; height: 80px; margin: 0 auto 10px; position: relative; }
        .default-profile-icon { font-size: 80px; color: var(--secondary-text); }
        #drawer-profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); }
        #drawer-user-name { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }
        #profile-edit-link { display: inline-block; font-size: 0.9rem; color: var(--accent-color); text-decoration: none; padding: 5px 10px; border-radius: 15px; border: 1px solid transparent; }
        #profile-edit-link:hover { border-color: var(--accent-color); }
        .nav-divider { height: 1px; background-color: var(--border-color); margin: 15px 20px; }
        #side-drawer ul { list-style: none; padding: 0; }
        #side-drawer ul li a { display: flex; align-items: center; padding: 12px 20px; color: var(--primary-text); text-decoration: none; font-size: 1rem; transition: background-color 0.2s, color 0.2s; border-left: 3px solid transparent; }
        #side-drawer ul li a.active { border-left-color: var(--accent-color); color: var(--accent-color); font-weight: bold; background-color: var(--secondary-bg); }
        .drawer-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-top: 1px solid var(--border-color); }
        .drawer-footer p { color: var(--secondary-text); font-size: 0.8rem; }
        .drawer-footer .icon-btn { color: var(--error-color); }
        #page-container { flex-grow: 1; padding: 65px 15px 15px; overflow-y: auto; position: relative; }
        .page { display: none; }
        .page.active { display: block; animation: fadeInPage 0.4s ease-in-out; }
        @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }
        .content-section { padding: 20px 0; }
        .content-section h2 { font-family: var(--font-display); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #trending-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        #app-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .app-card { display: flex; flex-direction: column; background-color: var(--secondary-bg); border-radius: 12px; overflow: hidden; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s ease; padding: 10px; }
        .app-card:hover { transform: translateY(-4px); box-shadow: 0 0 8px 0px var(--accent-color); }
        .app-card .app-logo { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 22%; margin-bottom: 8px; }
        .app-card .app-info { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
        .app-name { font-size: 0.9rem; font-weight: bold; color: var(--primary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;}
        .app-uploader { font-size: 0.8rem; color: var(--accent-color); margin-top: 2px; }
        .app-stats { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--secondary-text); margin-top: 4px; }
        .app-stats span { display: flex; align-items: center; gap: 3px; }
        .app-stats .fa-star { color: var(--star-color); }
        .trending-card { display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--secondary-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; aspect-ratio: 1/1; }
        .trending-card:hover { border-color: var(--accent-color); transform: translateY(-2px); box-shadow: 0 0 10px var(--accent-glow); }
        .trending-card img { width: 60%; height: 60%; border-radius: 25%; flex-shrink: 0; margin-bottom: 10px; }
        .trending-card .app-info { text-align: center; }
        .trending-card .app-info h3 { font-size: 1rem; }
        .category-tabs { display: flex; justify-content: center; padding: 0 0 15px; gap: 10px; }
        .category-tab { background: none; border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
        .category-tab.active, .category-tab:hover { background-color: var(--accent-color); border-color: var(--accent-color); color: var(--secondary-bg); }
        .dark-theme .category-tab.active, .dark-theme .category-tab:hover { color: #000; }
        .detail-header { display: flex; align-items: center; padding: 10px 5px; gap: 15px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background-color: var(--header-bg); z-index: 10; }
        .detail-content { padding: 20px; }
        .detail-main-info { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 25px; }
        #detail-app-logo { width: 80px; height: 80px; border-radius: 20px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); flex-shrink: 0; }
        #detail-app-title { font-family: var(--font-display); font-size: 1.6rem; line-height: 1.2; }
        #detail-app-developer { color: var(--accent-color); font-size: 1rem; margin-top: 5px; font-weight: bold; }
        #detail-stats-container { display: flex; gap: 20px; margin-top: 10px; color: var(--secondary-text); font-size: 0.9rem; align-items: center; }
        .detail-stat { text-align: center; }
        .detail-stat strong { display: block; color: var(--primary-text); font-size: 1.1rem; }
        .detail-stat .fa-star { color: var(--star-color); }
        
        /* NEW: Container for Download and Share buttons */
        .action-buttons-container { display: flex; gap: 10px; margin-bottom: 25px; }
        .action-buttons-container .form-btn { margin-top: 0; flex: 1; }
        .action-buttons-container .form-btn.share { background-color: var(--secondary-text); }
        
        #screenshots-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 15px; scrollbar-width: none; }
        #screenshots-container::-webkit-scrollbar { display: none; }
        #screenshots-container img { height: 200px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color); cursor: pointer; }
        .detail-section { margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 25px; }
        .detail-section:last-child { border-bottom: none; }
        .detail-section h3 { font-family: var(--font-display); font-size: 1.1rem; margin-bottom: 10px; color: var(--accent-color); }
        .expandable-description { position: relative; padding-bottom: 40px; }
        .expandable-description p { max-height: 4.5em; overflow: hidden; line-height: 1.5em; transition: max-height 0.3s ease-out; }
        .expandable-description.expanded p { max-height: 1000px; }
        .expand-arrow { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); background: none; border: none; color: var(--accent-color); cursor: pointer; font-size: 1.5rem; }
        .expandable-description.expanded .expand-arrow { transform: translateX(-50%) rotate(180deg); }
        #comment-form { background-color: var(--primary-bg); padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--border-color); }
        #comment-form-title { font-size: 1.1rem; margin-bottom: 10px; color: var(--primary-text); }
        .rating-input { margin-bottom: 10px; text-align: center;}
        .rating-input i { font-size: 1.8rem; color: var(--secondary-text); cursor: pointer; margin: 0 5px; transition: color 0.2s, transform 0.2s; }
        .rating-input i:hover { transform: scale(1.1); }
        .rating-input i.fas { color: var(--star-color); }
        #comment-form button { display: block; margin-left: auto; width: auto; padding: 10px 20px; }
        .comment-item { display: flex; gap: 15px; margin-top: 20px; }
        .comment-avatar { flex-shrink: 0; }
        .comment-avatar img, .comment-avatar .default-profile-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .comment-avatar .default-profile-icon { font-size: 40px; color: var(--secondary-text); }
        .comment-body { flex-grow: 1; }
        .comment-header { display: flex; align-items: baseline; gap: 10px; margin-bottom: 5px; flex-wrap: wrap; }
        .comment-header .user-name { font-weight: bold; }
        .comment-header .star-rating { color: var(--star-color); }
        .comment-text { line-height: 1.6; word-break: break-word; }
        .comment-date { font-size: 0.8rem; color: var(--secondary-text); }
        .settings-content { padding: 20px; }
        .setting-title { font-family: var(--font-display); color: var(--accent-color); margin: 25px 0 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .placeholder-content { padding: 20px; text-align: center; }
        .developed-by { margin-top: 40px; font-size: 1.1rem; color: var(--secondary-text); font-weight: bold; }
        #my-apps-screen .page-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .upload-btn { background-color: var(--accent-color); color: var(--secondary-bg); padding: 10px 15px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }
        .dark-theme .upload-btn { color: #000; }
        .my-app-item { display: flex; align-items: center; gap: 15px; background-color: var(--secondary-bg); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .my-app-item img { width: 50px; height: 50px; border-radius: 10px; }
        .my-app-info { flex-grow: 1; }
        .my-app-info h4 { margin: 0; }
        .status-badge { font-size: 0.8rem; font-weight: bold; padding: 3px 8px; border-radius: 10px; }
        .status-badge.pending { background-color: var(--pending-color); color: #000; }
        .my-app-actions { display: flex; gap: 5px; }
        .my-app-actions .icon-btn { color: var(--secondary-text); }
        .file-input-custom { border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-top: 10px; }
        .file-input-custom:hover { border-color: var(--accent-color); }
        .file-list { margin-top: 10px; font-size: 0.9em; color: var(--secondary-text); }
        #upload-progress-list { list-style: none; padding: 0; }
        .progress-item-name { display: block; margin-bottom: 5px; color: var(--primary-text); }
        .progress-bar-container { width: 100%; background: var(--border-color); border-radius: 5px; height: 10px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.3s ease; }
        .progress-status { font-weight: bold; margin-left: 10px; font-size: 0.8rem; }
        .progress-item-name .fa-check-circle { color: var(--success-color); margin-right: 5px; }
        .progress-item-name .fa-exclamation-circle { color: var(--error-color); margin-right: 5px; }
        #upload-overall-status { margin-top: 20px; text-align: center; font-weight: bold; color: var(--accent-color); }
        
        @media (min-width: 768px) {
            #side-drawer { left: 0; width: 250px; box-shadow: none; }
            #main-content { margin-left: 250px; }
            #menu-btn { display: none; }
            #main-header { width: calc(100% - 250px); }
            #app-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body class="light-theme" data-font="Roboto">

    <!-- =========== GLOBAL MODALS =========== -->
    <div id="notification-modal" class="modal-overlay hidden"><div class="modal-container notification-container"><div class="modal-header"><h2 id="notification-title">Notification</h2></div><div class="modal-content"><p id="notification-message"></p></div><div class="notification-footer"><button id="notification-cancel" class="notification-btn secondary">Cancel</button><button id="notification-ok" class="notification-btn primary">OK</button></div></div></div>
    <div id="upload-modal" class="modal-overlay hidden"><div class="modal-container"><div class="modal-header"><h2 id="upload-modal-title">Uploading App...</h2></div><div class="modal-content"><ul id="upload-progress-list"></ul><div id="upload-overall-status"></div></div></div></div>

    <!-- =========== AUTH WALL (Now an overlay) =========== -->
    <div id="auth-wall" class="hidden"><div id="auth-container"><button id="close-auth-wall-btn" class="close-modal-btn" style="position: absolute; top: 10px; right: 15px; font-size: 1.5rem;">×</button><h1 class="auth-title">FutureStore</h1><div class="auth-tabs"><button class="auth-tab-btn active" data-form="login">Login</button><button class="auth-tab-btn" data-form="signup">Sign Up</button></div><div class="auth-form-container"><form id="login-form" class="auth-form active"><input type="email" id="login-email" class="form-input" placeholder="Email" required><input type="password" id="login-password" class="form-input" placeholder="Password" required><span id="login-error-message" style="color: var(--error-color); font-size: 0.85rem; margin-top: -10px; margin-bottom: 15px; display: block;"></span><button type="submit" class="form-btn">Login</button></form><form id="signup-form" class="auth-form"><input type="text" id="signup-name" class="form-input" placeholder="Display Name" required><input type="email" id="signup-email" class="form-input" placeholder="Email" required><input type="password" id="signup-password" class="form-input" placeholder="Password (min 6 characters)" required><input type="password" id="signup-confirm" class="form-input" placeholder="Confirm Password" required><span id="signup-password-error" style="color: var(--error-color); font-size: 0.85rem; margin-top: -10px; margin-bottom: 15px; display: block;"></span><button type="submit" class="form-btn">Create Account</button></form></div></div></div>
    
    <!-- Skeleton Loader (Will be hidden by JS) -->
    <div id="skeleton-loader"><div class="skeleton-full-content"><div class="skeleton-top-bar"><div class="skeleton-menu-btn"></div><div class="skeleton-title-bar"></div></div><div class="skeleton-grid-section"><div class="skeleton-grid-item"></div><div class="skeleton-grid-item"></div><div class="skeleton-grid-item"></div><div class="skeleton-grid-item"></div><div class="skeleton-grid-item"></div><div class="skeleton-grid-item"></div></div></div></div>
    
    <!-- =========== THE MAIN APP (USER PANEL) =========== -->
    <div id="app-wrapper" class="hidden">
        <div id="screenshot-viewer" class="modal-overlay hidden"><button class="close-modal-btn">×</button><button class="screenshot-nav prev"><i class="fas fa-chevron-left"></i></button><img id="fullscreen-screenshot" src="" alt="Screenshot Preview"><button class="screenshot-nav next"><i class="fas fa-chevron-right"></i></button></div>
        <div id="sort-modal" class="dropdown-menu hidden"><a href="#" class="sort-option active" data-sort="newest">Newest First</a><a href="#" class="sort-option" data-sort="oldest">Oldest First</a><a href="#" class="sort-option" data-sort="rating">Highest Rated</a></div>
        
        <nav id="side-drawer"><div class="drawer-content"><div class="drawer-profile-section"><div class="profile-pic-container"><i class="fas fa-user-circle default-profile-icon"></i><img id="drawer-profile-pic" src="" alt="Profile" class="hidden"></div><p id="drawer-user-name">User</p><a href="#" id="profile-edit-link">Edit Profile</a></div><div class="nav-divider"></div><ul><li><a href="#" class="nav-link active" data-page="home-screen"><i class="fas fa-home"></i> Home</a></li><li class="nav-divider"></li><li><a href="#" class="nav-link category-filter active" data-category="All"><i class="fas fa-th-large"></i> All Apps</a></li><li><a href="#" class="nav-link category-filter" data-category="Apps"><i class="fas fa-robot"></i> Apps</a></li><li><a href="#" class="nav-link category-filter" data-category="Games"><i class="fas fa-gamepad"></i> Games</a></li><li class="nav-divider"></li><li id="my-apps-nav-item" class="hidden"><a href="#" class="nav-link" data-page="my-apps-screen"><i class="fas fa-upload"></i> My Apps</a></li><li id="settings-nav-item" class="hidden"><a href="#" class="nav-link" data-page="settings-screen"><i class="fas fa-cog"></i> Settings</a></li><li><a href="#" class="nav-link" data-page="about-screen"><i class="fas fa-info-circle"></i> About</a></li></ul></div><div class="drawer-footer"><p>Version 20.5.8</p><button id="drawer-logout-btn" class="icon-btn hidden"><i class="fas fa-sign-out-alt"></i></button></div></nav>
        <div id="drawer-overlay"></div>

        <div id="main-content">
            <header id="main-header"><button id="menu-btn" class="icon-btn"><i class="fas fa-bars"></i></button><h1 id="header-title">FutureStore</h1><div class="header-actions"><button id="sort-btn" class="icon-btn"><i class="fas fa-sort-amount-down"></i></button><button id="theme-toggle-btn" class="icon-btn"><i class="fas fa-moon moon-icon"></i><i class="fas fa-sun sun-icon"></i></button></div></header>
            <main id="page-container">
                <section id="home-screen" class="page active"><div class="search-bar-container" style="margin-bottom: 10px; position: relative;"><input type="text" id="app-search-input" class="form-input" placeholder="Search apps..." style="padding-right: 40px;"><i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary-text);"></i></div><div id="trending-section" class="content-section" style="padding-top: 0;"><h2>Trending</h2><div id="trending-grid"></div></div><div class="content-section"><div class="category-tabs"><button class="category-tab active" data-category="All">All</button><button class="category-tab" data-category="Apps">Apps</button><button class="category-tab" data-category="Games">Games</button></div><div id="app-grid"></div></div></section>
                <section id="detail-screen" class="page"><div class="detail-header"><button id="back-btn" class="icon-btn"><i class="fas fa-arrow-left"></i></button><h2 id="detail-app-title-header">App Details</h2></div><div class="detail-content"><div class="detail-main-info"><img id="detail-app-logo" src="" alt="App Logo"><div class="detail-title-group"><h1 id="detail-app-title"></h1><p id="detail-app-developer"></p><div id="detail-stats-container"></div></div></div>
                    <!-- MODIFIED: Container for Download and Share buttons -->
                    <div class="action-buttons-container">
                        <button id="download-btn" class="form-btn download"><i class="fas fa-download"></i> Download</button>
                        <button id="share-btn" class="form-btn share"><i class="fas fa-share-alt"></i> Share</button>
                    </div>
                <div id="screenshots-container"></div><div class="detail-section expandable-description"><h3>Description</h3><p id="detail-app-description"></p><button class="expand-arrow"><i class="fas fa-chevron-down"></i></button></div><div class="detail-section"><h3>What's New</h3><p id="detail-app-version"></p></div><div class="detail-section"><h3>Ratings & Reviews</h3><form id="comment-form"><h4 id="comment-form-title">Leave a Review</h4><div class="rating-input"><i class="far fa-star" data-value="1"></i><i class="far fa-star" data-value="2"></i><i class="far fa-star" data-value="3"></i><i class="far fa-star" data-value="4"></i><i class="far fa-star" data-value="5"></i></div><textarea id="comment-text" class="form-input" placeholder="Tell others what you think..." required></textarea><button type="submit" class="form-btn">Submit</button></form><div id="comments-container"></div></div></div></section>
                <section id="settings-screen" class="page"><div class="detail-header"><button class="back-to-home icon-btn"><i class="fas fa-arrow-left"></i></button><h2>Settings</h2></div><div class="settings-content"><h3 class="setting-title">Appearance</h3><div class="setting-item"><label for="font-select">App Font</label><select id="font-select" class="form-input"><option value="Roboto">Roboto (Default)</option><option value="Lato">Lato</option><option value="Montserrat">Montserrat</option><option value="Open Sans">Open Sans</option><option value="Source Code Pro">Source Code Pro</option></select></div><h3 class="setting-title">Profile Management</h3><div id="edit-profile-section" class="content-section"><form id="profile-edit-form" novalidate><div class="profile-pic-editor"><div id="profile-pic-preview"><i class="fas fa-user default-profile-icon"></i></div><input type="file" id="profile-pic-input" class="hidden" accept="image/*"><button type="button" id="change-pic-btn">Change Picture</button></div><label for="profile-name-input" class="form-label-icon"><i class="fas fa-user"></i><span>Display Name</span></label><input type="text" id="profile-name-input" class="form-input" required><button type="submit" class="form-btn">Save Changes</button></form></div></div></section>
                <section id="about-screen" class="page"><div class="detail-header"><button class="back-to-home icon-btn"><i class="fas fa-arrow-left"></i></button><h2>About FutureStore</h2></div><div class="placeholder-content"><h3>FutureStore</h3><p>Your portal to the next generation of applications.</p><p class="developed-by">Developed By Dheeraj ❤️</p> <button id="show-login-btn" class="form-btn" style="max-width: 200px; margin: 20px auto 0;">Login / Sign Up</button> </div></section>
                <section id="my-apps-screen" class="page"><div class="detail-header"><button class="back-to-home icon-btn"><i class="fas fa-arrow-left"></i></button><h2>My Apps</h2><button id="upload-app-btn" class="upload-btn" style="margin-left: auto;"><i class="fas fa-plus"></i> Upload</button></div><div id="my-apps-list" class="detail-content" style="padding-top: 0;"></div><div id="my-apps-placeholder" class="placeholder-content hidden"><p>You haven't uploaded any apps yet.</p></div></section>
                <section id="upload-edit-screen" class="page"><div class="detail-header"><button id="back-to-my-apps" class="icon-btn"><i class="fas fa-arrow-left"></i></button><h2 id="user-app-form-title">Upload App</h2></div><div class="detail-content"><form id="user-app-form"><input type="hidden" id="user-app-id-input"><div class="form-group"><label for="user-app-title">App Title</label><input type="text" id="user-app-title" class="form-input" required></div><div class="form-group"><label for="user-app-description">Description</label><textarea id="user-app-description" class="form-input" required></textarea></div><div class="form-group"><label for="user-app-version">Version</label><input type="text" id="user-app-version" class="form-input" placeholder="e.g., 1.0.0" required></div><div class="form-group"><label for="user-app-category">Category</label><select id="user-app-category" class="form-input" required><option value="Apps">Apps</option><option value="Games">Games</option></select></div><div class="form-group"><label>Logo</label><input type="file" id="user-app-logo-input" class="hidden" accept="image/*"><div class="file-input-custom" onclick="this.previousElementSibling.click()"><p id="user-logo-file-name">Click to select a logo</p></div></div><div class="form-group"><label>Screenshots (up to 5)</label><input type="file" id="user-app-screenshots-input" class="hidden" accept="image/*" multiple><div class="file-input-custom" onclick="this.previousElementSibling.click()"><p>Click to select screenshots</p></div><div id="user-screenshots-file-list" class="file-list"></div></div><div class="form-group"><label for="user-app-apk-size">APK Size (MB)</label><input type="number" id="user-app-apk-size" class="form-input" step="0.1" min="0" placeholder="e.g., 15.3" required></div><div class="form-group"><label>APK Download Link</label><input type="url" id="user-app-apk-link-input" class="form-input" placeholder="https://example.com/myapp.apk" required></div><button type="submit" class="form-btn">Submit for Review</button></form></div></section>
            </main>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.database();

        const DOMElements = {
            body: document.body,
            authWall: document.getElementById('auth-wall'),
            skeletonLoader: document.getElementById('skeleton-loader'),
            appWrapper: document.getElementById('app-wrapper'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            signupPasswordError: document.getElementById('signup-password-error'),
            authTabBtns: document.querySelectorAll('.auth-tab-btn'),
            closeAuthWallBtn: document.getElementById('close-auth-wall-btn'),
            showLoginBtn: document.getElementById('show-login-btn'),
            notificationModal: document.getElementById('notification-modal'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            notificationOk: document.getElementById('notification-ok'),
            notificationCancel: document.getElementById('notification-cancel'),
            uploadModal: document.getElementById('upload-modal'),
            uploadModalTitle: document.getElementById('upload-modal-title'),
            uploadProgressList: document.getElementById('upload-progress-list'),
            uploadOverallStatus: document.getElementById('upload-overall-status'),
            screenshotViewer: document.getElementById('screenshot-viewer'),
            fullscreenScreenshot: document.getElementById('fullscreen-screenshot'),
            screenshotNavPrev: document.querySelector('.screenshot-nav.prev'),
            screenshotNavNext: document.querySelector('.screenshot-nav.next'),
            profilePicPreview: document.getElementById('profile-pic-preview'),
            profileNameInput: document.getElementById('profile-name-input'),
            sortModal: document.getElementById('sort-modal'),
            sortBtn: document.getElementById('sort-btn'),
            sideDrawer: document.getElementById('side-drawer'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            menuBtn: document.getElementById('menu-btn'),
            drawerProfilePic: document.getElementById('drawer-profile-pic'),
            defaultProfileIcon: document.querySelector('.default-profile-icon'),
            drawerUserName: document.getElementById('drawer-user-name'),
            profileEditLink: document.getElementById('profile-edit-link'),
            drawerLogoutBtn: document.getElementById('drawer-logout-btn'),
            myAppsNavItem: document.getElementById('my-apps-nav-item'),
            settingsNavItem: document.getElementById('settings-nav-item'),
            trendingGrid: document.getElementById('trending-grid'),
            appGrid: document.getElementById('app-grid'),
            categoryTabs: document.querySelectorAll('.category-tab'),
            navLinks: document.querySelectorAll('.nav-link'),
            categoryFilters: document.querySelectorAll('.category-filter'),
            pages: document.querySelectorAll('.page'),
            pageContainer: document.getElementById('page-container'),
            backBtn: document.getElementById('back-btn'),
            shareBtn: document.getElementById('share-btn'), // The new share button
            genericBackBtns: document.querySelectorAll('.back-to-home'),
            detailAppLogo: document.getElementById('detail-app-logo'),
            detailAppTitle: document.getElementById('detail-app-title'),
            detailAppTitleHeader: document.getElementById('detail-app-title-header'),
            detailAppDeveloper: document.getElementById('detail-app-developer'),
            detailStatsContainer: document.getElementById('detail-stats-container'),
            downloadBtn: document.getElementById('download-btn'),
            screenshotsContainer: document.getElementById('screenshots-container'),
            expandableDescription: document.querySelector('.expandable-description'),
            detailAppDescription: document.getElementById('detail-app-description'),
            expandArrow: document.querySelector('.expand-arrow'),
            detailAppVersion: document.getElementById('detail-app-version'),
            commentForm: document.getElementById('comment-form'),
            commentsContainer: document.getElementById('comments-container'),
            ratingInput: document.querySelector('.rating-input'),
            ratingStars: document.querySelectorAll('.rating-input i'),
            commentText: document.getElementById('comment-text'),
            fontSelect: document.getElementById('font-select'),
            myAppsScreen: document.getElementById('my-apps-screen'),
            uploadAppBtn: document.getElementById('upload-app-btn'),
            myAppsList: document.getElementById('my-apps-list'),
            myAppsPlaceholder: document.getElementById('my-apps-placeholder'),
            backToMyAppsBtn: document.getElementById('back-to-my-apps'),
            userAppForm: document.getElementById('user-app-form'),
            userAppFormTitle: document.getElementById('user-app-form-title'),
            userAppIdInput: document.getElementById('user-app-id-input'),
            userAppTitleInput: document.getElementById('user-app-title'),
            userAppDescInput: document.getElementById('user-app-description'),
            userAppVersionInput: document.getElementById('user-app-version'),
            userAppCategoryInput: document.getElementById('user-app-category'),
            userAppLogoInput: document.getElementById('user-app-logo-input'),
            userLogoFileName: document.getElementById('user-logo-file-name'),
            userAppScreenshotsInput: document.getElementById('user-app-screenshots-input'),
            userScreenshotsFileList: document.getElementById('user-screenshots-file-list'),
            userAppApkLinkInput: document.getElementById('user-app-apk-link-input'),
            userAppApkSizeInput: document.getElementById('user-app-apk-size'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            editProfileFormBtn: document.querySelector('#profile-edit-form .form-btn'),
            appSearchInput: document.getElementById('app-search-input')
        };
        let notificationResolver = null;
        let appState = { currentUser: null };
        const guestUser = { uid: 'guest', name: 'Guest User', email: '' };

        function showNotification({ title = 'Notification', message, type = 'alert' }) {
            DOMElements.notificationTitle.textContent = title;
            DOMElements.notificationMessage.innerHTML = message;
            DOMElements.notificationCancel.style.display = (type === 'confirm') ? 'inline-block' : 'none';
            DOMElements.notificationModal.classList.remove('hidden');
            return new Promise((resolve) => { notificationResolver = resolve; });
        }
        function closeNotificationModal(result) {
            DOMElements.notificationModal.classList.add('hidden');
            if (notificationResolver) notificationResolver(result);
        }
        DOMElements.notificationOk.addEventListener('click', () => closeNotificationModal(true));
        DOMElements.notificationCancel.addEventListener('click', () => closeNotificationModal(false));
        
        const handleLogin = (e) => { e.preventDefault(); const email = DOMElements.loginForm.querySelector('input[type=email]').value; const password = DOMElements.loginForm.querySelector('input[type=password]').value; const btn = e.target.querySelector('.form-btn'); const loginErrorMessageSpan = document.getElementById('login-error-message'); loginErrorMessageSpan.textContent = ''; btn.classList.add('loading'); btn.disabled = true; auth.signInWithEmailAndPassword(email, password).catch(err => { loginErrorMessageSpan.textContent = "Invalid email or password."; }).finally(() => { if(btn) { btn.classList.remove('loading'); btn.disabled = false; } }); };
        const handleSignup = async (e) => { e.preventDefault(); const name = DOMElements.signupForm.querySelector('#signup-name').value; const email = DOMElements.signupForm.querySelector('#signup-email').value; const password = DOMElements.signupForm.querySelector('#signup-password').value; const confirmPass = DOMElements.signupForm.querySelector('#signup-confirm').value; DOMElements.signupPasswordError.textContent = ''; if (password.length < 6) { DOMElements.signupPasswordError.textContent = "Password must be at least 6 characters."; return; } if (password !== confirmPass) { DOMElements.signupPasswordError.textContent = "Passwords do not match."; return; } const btn = e.target.querySelector('.form-btn'); btn.classList.add('loading'); btn.disabled = true; try { const userCredential = await auth.createUserWithEmailAndPassword(email, password); await db.ref(`users/${userCredential.user.uid}`).set({ name, email, role: 'user', profilePicUrl: '', uploads: 0 }); } catch (err) { showNotification({ title: 'Signup Failed', message: err.message }); } finally { if(btn) { btn.classList.remove('loading'); btn.disabled = false; } } };

        DOMElements.loginForm.addEventListener('submit', handleLogin);
        DOMElements.signupForm.addEventListener('submit', handleSignup);
        DOMElements.authTabBtns.forEach(tab => { tab.addEventListener('click', () => { DOMElements.authTabBtns.forEach(t => t.classList.remove('active')); tab.classList.add('active'); document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active')); document.getElementById(`${tab.dataset.form}-form`).classList.add('active'); }); });
        DOMElements.showLoginBtn.addEventListener('click', () => DOMElements.authWall.classList.remove('hidden'));
        DOMElements.closeAuthWallBtn.addEventListener('click', () => DOMElements.authWall.classList.add('hidden'));
        DOMElements.authWall.addEventListener('click', (e) => { if (e.target === DOMElements.authWall) { DOMElements.authWall.classList.add('hidden'); } });

        auth.onAuthStateChanged(async (user) => {
            DOMElements.skeletonLoader.classList.add('hidden');
            DOMElements.appWrapper.classList.remove('hidden');
            if (user) {
                db.ref(`users/${user.uid}`).on('value', (snapshot) => {
                    if (snapshot.exists() && snapshot.val().isBanned === true) {
                        auth.signOut(); 
                        showNotification({title: "Account Banned", message: "Your account has been banned."});
                        initializeApp(guestUser);
                    } else {
                        const userData = snapshot.exists() ? { uid: user.uid, email: user.email, ...snapshot.val() } : { uid: user.uid, name: user.email, email: user.email };
                        initializeApp(userData);
                        DOMElements.authWall.classList.add('hidden');
                    }
                });
            } else {
                initializeApp(guestUser);
            }
        });

        function updateUiForLoginStatus(isGuest) {
            DOMElements.showLoginBtn.classList.toggle('hidden', !isGuest);
            DOMElements.myAppsNavItem.classList.toggle('hidden', isGuest);
            DOMElements.settingsNavItem.classList.toggle('hidden', isGuest);
            DOMElements.drawerLogoutBtn.classList.toggle('hidden', isGuest);
            DOMElements.profileEditLink.style.display = isGuest ? 'none' : 'inline-block';
            DOMElements.commentForm.style.pointerEvents = isGuest ? 'none' : 'auto';
            DOMElements.commentForm.style.opacity = isGuest ? 0.5 : 1;
            DOMElements.commentText.placeholder = isGuest ? "Please log in to leave a review." : "Tell others what you think...";
            DOMElements.commentText.disabled = isGuest;
        }

        let isAppInitialized = false;
        function initializeApp(user) {
           const isGuest = user.uid === 'guest';
           if (isAppInitialized && appState.currentUser.uid === user.uid) {
               updateUIForUser(user);
               return;
           }
           
           isAppInitialized = true;
           appState = { currentUser: user, allApps: [], trendingApps: [], myPendingApps: [], currentSort: 'newest', currentCategory: 'All', currentDetailApp: null, currentScreenshots: [], currentScreenshotIndex: 0, userRating: 0, currentPage: 'home-screen', selectedScreenshots: [], searchQuery: '' };
            
           updateUiForLoginStatus(isGuest);
            
            const navigate = (pageId) => {
                if (!isGuest && (pageId === 'my-apps-screen' || pageId === 'settings-screen' || pageId === 'upload-edit-screen')) {
                     // Allow access
                } else if (isGuest && (pageId === 'my-apps-screen' || pageId === 'settings-screen' || pageId === 'upload-edit-screen')) {
                    showNotification({title: "Login Required", message: "Please log in to access this feature."});
                    DOMElements.authWall.classList.remove('hidden');
                    return;
                }
                DOMElements.pages.forEach(p => p.classList.remove('active'));
                const newPage = document.getElementById(pageId);
                if (newPage) newPage.classList.add('active');
                DOMElements.pageContainer.scrollTop = 0;
                appState.currentPage = pageId;
                DOMElements.navLinks.forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
                if (activeLink) activeLink.classList.add('active');
            };

            const toggleDrawer = () => { DOMElements.sideDrawer.classList.toggle('open'); DOMElements.drawerOverlay.classList.toggle('visible'); };
            function openScreenshotViewer(index) { appState.currentScreenshotIndex = parseInt(index, 10); DOMElements.fullscreenScreenshot.src = appState.currentScreenshots[appState.currentScreenshotIndex]; DOMElements.screenshotViewer.classList.remove('hidden'); }
            function updateUIForUser(currentUser) {
                appState.currentUser = currentUser;
                const { name, profilePicUrl } = currentUser;
                DOMElements.drawerUserName.textContent = name || 'User';
                if (profilePicUrl) { DOMElements.drawerProfilePic.src = profilePicUrl; DOMElements.drawerProfilePic.classList.remove('hidden'); DOMElements.defaultProfileIcon.classList.add('hidden'); } 
                else { DOMElements.drawerProfilePic.src = ''; DOMElements.drawerProfilePic.classList.add('hidden'); DOMElements.defaultProfileIcon.classList.remove('hidden'); }
                DOMElements.profileNameInput.value = name || '';
                if (profilePicUrl) { DOMElements.profilePicPreview.style.backgroundImage = `url(${profilePicUrl})`; DOMElements.profilePicPreview.innerHTML = ''; } 
                else { DOMElements.profilePicPreview.style.backgroundImage = 'none'; DOMElements.profilePicPreview.innerHTML = '<i class="fas fa-user default-profile-icon"></i>'; }
                DOMElements.editProfileFormBtn.disabled = isGuest;
            }
            
            async function handleProfileUpdate(e) { e.preventDefault(); if (isGuest) return; const newName = DOMElements.profileNameInput.value; const newPicFile = DOMElements.profilePicInput.files[0]; const btn = e.target.querySelector('.form-btn'); btn.classList.add('loading'); btn.disabled = true; try { let newPicUrl = appState.currentUser.profilePicUrl || ''; if (newPicFile) { newPicUrl = await uploadToImgbb(newPicFile); } await db.ref(`users/${appState.currentUser.uid}`).update({ name: newName, profilePicUrl: newPicUrl }); showNotification({ title: 'Success', message: 'Profile updated successfully!' }); } catch (err) { showNotification({ title: 'Error', message: 'Profile update failed: ' + err.message }); } finally { btn.classList.remove('loading'); btn.disabled = false; } }
            
            // NEW: Share button handler
            async function handleShare() {
                if (!appState.currentDetailApp) return;
                const { title, description } = appState.currentDetailApp;
                const shareData = {
                    title: `Check out ${title} on FutureStore!`,
                    text: description,
                    url: window.location.href 
                };
                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        throw new Error('Web Share API not supported');
                    }
                } catch (err) {
                    showNotification({title: "Can't Share", message: "Sharing is not supported on your browser."});
                }
            }

            function applyInitialSettings() { const theme = localStorage.getItem('theme') || 'light'; DOMElements.body.classList.toggle('dark-theme', theme === 'dark'); const font = localStorage.getItem('font') || 'Roboto'; applyFont(font); if (DOMElements.fontSelect) DOMElements.fontSelect.value = font; };
            function toggleTheme() { DOMElements.body.classList.toggle('dark-theme'); localStorage.setItem('theme', DOMElements.body.classList.contains('dark-theme') ? 'dark' : 'light'); };
            function applyFont(fontName) { document.body.dataset.font = fontName; localStorage.setItem('font', fontName); };

            function fetchApps() { db.ref('apps').orderByChild('isApproved').equalTo(true).on('value', snapshot => { appState.allApps = []; const data = snapshot.val(); if (data) { for (const key in data) { appState.allApps.push({ id: key, ...data[key] }); } } processAndDisplayApps(); }); }
            function processAndDisplayApps() { let appsToProcess = [...appState.allApps]; if (appState.searchQuery) { const query = appState.searchQuery.toLowerCase(); appsToProcess = appsToProcess.filter(app => app.title.toLowerCase().includes(query) || app.description.toLowerCase().includes(query) || (app.category && app.category.toLowerCase().includes(query))); } DOMElements.trendingGrid.closest('.content-section').classList.toggle('hidden', !!appState.searchQuery); if (!appState.searchQuery) { appState.trendingApps = [...appsToProcess].sort((a, b) => (b.downloadCount || 0) - (a.downloadCount || 0)).slice(0, 3); } appsToProcess.sort((a, b) => { if (appState.currentSort === 'newest') return (b.timestamp || 0) - (a.timestamp || 0); if (appState.currentSort === 'oldest') return (a.timestamp || 0) - (b.timestamp || 0); if (appState.currentSort === 'rating') return (calculateAvgRating(b) || 0) - (calculateAvgRating(a) || 0); return 0; }); renderApps(appsToProcess); }
            function calculateAvgRating(app) { if (!app.ratings) return 0; const ratings = Object.values(app.ratings); if (ratings.length === 0) return 0; return ratings.reduce((acc, curr) => acc + curr.rating, 0) / ratings.length; }
            function renderApps(apps) { const renderGrid = (gridElement, appArray) => { gridElement.innerHTML = ''; appArray.forEach(app => { const uploaderName = app.uploaderName || 'Admin'; const avgRating = calculateAvgRating(app).toFixed(1); const downloadCount = app.downloadCount || 0; const card = document.createElement('div'); card.className = gridElement.id === 'trending-grid' ? 'trending-card' : 'app-card'; card.dataset.appId = app.id; if (gridElement.id === 'trending-grid') { card.innerHTML = `<img src="${app.logoUrl}" alt="${app.title}"><div class="app-info"><h3>${app.title}</h3></div>`; } else { card.innerHTML = `<img src="${app.logoUrl}" alt="${app.title}" class="app-logo"><div class="app-info"><h3 class="app-name">${app.title}</h3><p class="app-uploader">${uploaderName}</p><div class="app-stats"><span><i class="fas fa-star"></i> ${avgRating}</span><span><i class="fas fa-download"></i> ${downloadCount}</span></div></div>`; } card.addEventListener('click', () => showAppDetails(app.id)); gridElement.appendChild(card); }); }; renderGrid(DOMElements.trendingGrid, appState.trendingApps); const filteredApps = appState.currentCategory === 'All' ? apps : apps.filter(app => app.category && app.category.toLowerCase() === appState.currentCategory.toLowerCase()); renderGrid(DOMElements.appGrid, filteredApps); }
            function showAppDetails(appId) { const app = appState.allApps.find(a => a.id === appId); if (!app) return; appState.currentDetailApp = app; DOMElements.detailAppLogo.src = app.logoUrl; DOMElements.detailAppTitle.textContent = app.title; DOMElements.detailAppTitleHeader.textContent = app.title; DOMElements.detailAppDeveloper.textContent = app.uploaderName || 'Admin'; const avgRating = calculateAvgRating(app).toFixed(1); const ratingCount = app.ratings ? Object.keys(app.ratings).length : 0; const downloadCount = app.downloadCount || 0; const apkSize = app.apkSize ? `${app.apkSize} MB` : 'N/A'; DOMElements.detailStatsContainer.innerHTML = `<div class="detail-stat"><strong>${avgRating} <i class="fas fa-star"></i></strong><span>${ratingCount} reviews</span></div><div class="detail-stat"><strong>${downloadCount}</strong><span>Downloads</span></div><div class="detail-stat"><strong>${apkSize}</strong><span>APK Size</span></div>`; DOMElements.detailAppDescription.textContent = app.description; DOMElements.detailAppVersion.textContent = app.version || 'N/A'; DOMElements.expandableDescription.classList.remove('expanded'); appState.currentScreenshots = app.screenshots || []; DOMElements.screenshotsContainer.innerHTML = appState.currentScreenshots.map((ss, index) => `<img src="${ss}" alt="Screenshot ${index + 1}" data-index="${index}">`).join(''); DOMElements.commentText.value = ''; resetRatingStars(); loadRatingsAndComments(appId); navigate('detail-screen'); }
            function loadRatingsAndComments(appId) { const ratingsRef = db.ref(`apps/${appId}/ratings`); ratingsRef.on('value', async (snapshot) => { const ratingsData = snapshot.val(); DOMElements.commentsContainer.innerHTML = ''; if (ratingsData) { for (const userId of Object.keys(ratingsData)) { const rating = ratingsData[userId]; const userSnap = await db.ref(`users/${userId}`).once('value'); const userData = userSnap.val() || {name: 'Anonymous'}; renderComment(rating, userData); } } }); }
            function renderComment(commentData, userData) { const commentEl = document.createElement('div'); commentEl.className = 'comment-item'; const profilePic = userData.profilePicUrl ? `<img src="${userData.profilePicUrl}" alt="Avatar">` : '<i class="fas fa-user-circle default-profile-icon"></i>'; const date = new Date(commentData.timestamp).toLocaleDateString(); commentEl.innerHTML = `<div class="comment-avatar">${profilePic}</div><div class="comment-body"><div class="comment-header"><span class="user-name">${userData.name}</span><span class="comment-date">${date}</span></div><div class="star-rating">${'★'.repeat(commentData.rating)}${'☆'.repeat(5-commentData.rating)}</div><p class="comment-text">${commentData.text}</p></div>`; DOMElements.commentsContainer.prepend(commentEl); }
            async function handleCommentSubmit(e) { e.preventDefault(); if (isGuest) { DOMElements.authWall.classList.remove('hidden'); return; } const commentText = DOMElements.commentText.value.trim(); if (!commentText || appState.userRating === 0) { return showNotification({title: "Incomplete", message: "Please select a star rating and write a comment."}); } const btn = e.target.querySelector('.form-btn'); btn.classList.add('loading'); btn.disabled = true; try { const appId = appState.currentDetailApp.id; const newRating = { rating: appState.userRating, text: commentText, timestamp: firebase.database.ServerValue.TIMESTAMP }; await db.ref(`apps/${appId}/ratings/${appState.currentUser.uid}`).set(newRating); DOMElements.commentText.value = ''; resetRatingStars(); } catch (error) { showNotification({title: "Error", message: "Failed to submit review. " + error.message}); } finally { btn.classList.remove('loading'); btn.disabled = false; } }
            function navigateScreenshots(direction) { const newIndex = appState.currentScreenshotIndex + direction; if (newIndex >= 0 && newIndex < appState.currentScreenshots.length) { appState.currentScreenshotIndex = newIndex; DOMElements.fullscreenScreenshot.src = appState.currentScreenshots[appState.currentScreenshotIndex]; } }
            function handleRatingStarClick(e) { if(isGuest) return; appState.userRating = parseInt(e.target.dataset.value); DOMElements.ratingStars.forEach(star => { star.classList.toggle('fas', star.dataset.value <= appState.userRating); star.classList.toggle('far', star.dataset.value > appState.userRating); }); }
            function resetRatingStars() { appState.userRating = 0; DOMElements.ratingStars.forEach(star => { star.className = 'far fa-star'; }); }
            
            async function handleDownload() { const btn = DOMElements.downloadBtn; if (btn.disabled) return; btn.disabled = true; btn.classList.add('loading'); btn.innerHTML = ''; try { const appId = appState.currentDetailApp.id; const finalUrl = appState.currentDetailApp.downloadUrl; if (!finalUrl) { throw new Error("Download link is not available."); } const a = document.createElement('a'); a.href = finalUrl; a.download = `${appState.currentDetailApp.title.replace(/\s/g, '_')}.apk`; document.body.appendChild(a); a.click(); document.body.removeChild(a); db.ref(`apps/${appId}/downloadCount`).set(firebase.database.ServerValue.increment(1)); btn.classList.remove('loading'); btn.classList.add('success'); btn.innerHTML = '<i class="fas fa-check"></i> Download Started'; } catch (err) { showNotification({title: "Download Failed", message: err.message}); btn.classList.remove('loading'); btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed'; } finally { setTimeout(() => { btn.disabled = false; btn.classList.remove('success', 'loading'); btn.innerHTML = '<i class="fas fa-download"></i> Download'; }, 3000); } }
            
            function fetchMyApps() { if (isGuest) return; db.ref('pending_apps').orderByChild('uploaderId').equalTo(appState.currentUser.uid).on('value', snapshot => { appState.myPendingApps = []; if (snapshot.exists()) { snapshot.forEach(child => appState.myPendingApps.push({ id: child.key, ...child.val() })); } renderMyApps(); }); }
            function renderMyApps() { DOMElements.myAppsPlaceholder.classList.toggle('hidden', appState.myPendingApps.length > 0); DOMElements.myAppsList.innerHTML = ''; appState.myPendingApps.forEach(app => { const appEl = document.createElement('div'); appEl.className = 'my-app-item'; appEl.innerHTML = `<img src="${app.logoUrl}" alt="logo"><div class="my-app-info"><h4>${app.title}</h4><span class="status-badge pending">Pending Approval</span></div><div class="my-app-actions"><button class="icon-btn edit-btn" title="Edit"><i class="fas fa-edit"></i></button><button class="icon-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button></div>`; appEl.querySelector('.edit-btn').addEventListener('click', () => populateUserAppFormForEdit(app)); appEl.querySelector('.delete-btn').addEventListener('click', () => deleteMyPendingApp(app.id, app.title)); DOMElements.myAppsList.appendChild(appEl); }); }
            function resetUserAppForm() { DOMElements.userAppForm.reset(); DOMElements.userAppIdInput.value = ''; DOMElements.userLogoFileName.textContent = 'Click to select a logo'; DOMElements.userScreenshotsFileList.textContent = ''; DOMElements.userAppApkLinkInput.value = ''; DOMElements.userAppFormTitle.textContent = 'Upload App'; DOMElements.userAppForm.querySelector('.form-btn').textContent = 'Submit for Review'; appState.selectedScreenshots = []; }
            function populateUserAppFormForEdit(app) { resetUserAppForm(); DOMElements.userAppFormTitle.textContent = 'Edit App'; DOMElements.userAppForm.querySelector('.form-btn').textContent = 'Save Changes'; DOMElements.userAppIdInput.value = app.id; DOMElements.userAppTitleInput.value = app.title; DOMElements.userAppDescInput.value = app.description; DOMElements.userAppVersionInput.value = app.version; DOMElements.userAppCategoryInput.value = app.category; DOMElements.userLogoFileName.textContent = 'Logo selected (leave to keep)'; DOMElements.userAppApkLinkInput.value = app.downloadUrl || ''; navigate('upload-edit-screen'); }
            async function deleteMyPendingApp(appId, title) { if (await showNotification({ title: 'Confirm Deletion', message: `Delete your submission for "${title}"?`, type: 'confirm' })) { await db.ref(`pending_apps/${appId}`).remove(); } }
            const uploadToImgbb = (file) => new Promise((resolve, reject) => { const formData = new FormData(); formData.append('image', file); fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, { method: 'POST', body: formData }).then(r => r.json()).then(d => d.success ? resolve(d.data.url) : reject(new Error(d.error.message))).catch(reject); });
            async function handleUserAppUpload(e) {
                e.preventDefault();
                const btn = e.target.querySelector('.form-btn');
                const isEditing = !!DOMElements.userAppIdInput.value;
                const logoFile = DOMElements.userAppLogoInput.files[0];
                const apkLink = DOMElements.userAppApkLinkInput.value.trim();
                if (!isEditing && (!logoFile || !apkLink)) { return showNotification({ title: 'Missing Information', message: 'A logo and an APK download link are required.' }); }
                btn.classList.add('loading'); btn.disabled = true;
                DOMElements.uploadModal.classList.remove('hidden'); DOMElements.uploadModalTitle.textContent = isEditing ? 'Updating Submission...' : 'Uploading Submission...'; DOMElements.uploadProgressList.innerHTML = ''; DOMElements.uploadOverallStatus.innerHTML = '';
                const addProgressItem = (id, name) => { const li = document.createElement('li'); li.id = `progress-${id}`; li.innerHTML = `<span class="progress-item-name">${name}</span><div style="display: flex; align-items: center;"><div class="progress-bar-container"><div class="progress-bar"></div></div><span class="progress-status">0%</span></div>`; DOMElements.uploadProgressList.appendChild(li); };
                const updateProgress = (id, percent, status) => { const item = document.getElementById(`progress-${id}`); if (!item) return; item.querySelector('.progress-bar').style.width = `${percent}%`; item.querySelector('.progress-status').textContent = status; if(percent >= 100){ item.querySelector('.progress-item-name').innerHTML = `<i class="fas fa-check-circle"></i> ${item.querySelector('.progress-item-name').textContent}`; } };
                try {
                    const existingData = isEditing ? (await db.ref(`pending_apps/${DOMElements.userAppIdInput.value}`).once('value')).val() : {};
                    let logoUrl = existingData.logoUrl, screenshotUrls = existingData.screenshots || [];
                    if (appState.selectedScreenshots.length > 0) { addProgressItem('ss', 'Screenshots...'); screenshotUrls = await Promise.all(appState.selectedScreenshots.map(uploadToImgbb)); updateProgress('ss', 100, 'Done'); }
                    if (logoFile) { addProgressItem('logo', 'Logo...'); logoUrl = await uploadToImgbb(logoFile); updateProgress('logo', 100, 'Done'); }
                    const apkSizeMB = parseFloat(DOMElements.userAppApkSizeInput.value);
                    if (isNaN(apkSizeMB) || apkSizeMB <= 0) { throw new Error("Invalid APK size."); }
                    const appData = { title: DOMElements.userAppTitleInput.value, description: DOMElements.userAppDescInput.value, version: DOMElements.userAppVersionInput.value, category: DOMElements.userAppCategoryInput.value, logoUrl, screenshots: screenshotUrls, downloadUrl: apkLink, apkSize: apkSizeMB, uploaderId: appState.currentUser.uid, uploaderName: appState.currentUser.name, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    const appRef = isEditing ? db.ref(`pending_apps/${DOMElements.userAppIdInput.value}`) : db.ref('pending_apps').push();
                    await appRef.set(appData);
                    if (!isEditing) await db.ref(`users/${appState.currentUser.uid}/uploads`).set(firebase.database.ServerValue.increment(1));
                    DOMElements.uploadOverallStatus.textContent = 'Submission successful!';
                    setTimeout(() => { DOMElements.uploadModal.classList.add('hidden'); resetUserAppForm(); navigate('my-apps-screen'); }, 1500);
                } catch (error) { DOMElements.uploadOverallStatus.innerHTML = `<span style="color:var(--error-color)">Error: ${error.message}</span>`; setTimeout(() => DOMElements.uploadModal.classList.add('hidden'), 4000); } finally { btn.classList.remove('loading'); btn.disabled = false; }
            }
            
            function setupEventListeners() {
                DOMElements.menuBtn.addEventListener('click', () => toggleDrawer());
                DOMElements.drawerOverlay.addEventListener('click', () => toggleDrawer(false));
                DOMElements.themeToggleBtn.addEventListener('click', toggleTheme);
                DOMElements.sortBtn.addEventListener('click', (e) => { e.stopPropagation(); DOMElements.sortModal.classList.toggle('hidden'); });
                DOMElements.drawerLogoutBtn.addEventListener('click', () => auth.signOut());
                DOMElements.profileEditLink.addEventListener('click', (e) => { e.preventDefault(); if(!isGuest) { navigate('settings-screen'); toggleDrawer(false); } });
                DOMElements.userAppForm.addEventListener('submit', handleUserAppUpload);
                document.getElementById('profile-edit-form').addEventListener('submit', handleProfileUpdate);
                document.getElementById('change-pic-btn').addEventListener('click', () => document.getElementById('profile-pic-input').click());
                window.addEventListener('click', (e) => { setTimeout(() => { if (!DOMElements.sortBtn.contains(e.target) && !DOMElements.sortModal.contains(e.target)) { DOMElements.sortModal.classList.add('hidden'); } }, 50); });
                DOMElements.sortModal.addEventListener('click', (e) => { if (e.target.classList.contains('sort-option')) { e.preventDefault(); appState.currentSort = e.target.dataset.sort; DOMElements.sortModal.querySelectorAll('.sort-option').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); processAndDisplayApps(); DOMElements.sortModal.classList.add('hidden'); } });
                DOMElements.navLinks.forEach(link => { if (link.dataset.page) { link.addEventListener('click', e => { e.preventDefault(); navigate(link.dataset.page); toggleDrawer(false); }); } });
                DOMElements.genericBackBtns.forEach(btn => btn.addEventListener('click', () => navigate('home-screen')));
                DOMElements.backBtn.addEventListener('click', () => navigate('home-screen'));
                DOMElements.backToMyAppsBtn.addEventListener('click', () => navigate('my-apps-screen'));
                const setCategory = (category) => { appState.currentCategory = category; document.querySelectorAll('.category-filter, .category-tab').forEach(el => { el.classList.toggle('active', el.dataset.category.toLowerCase() === category.toLowerCase()); }); processAndDisplayApps(); };
                DOMElements.categoryFilters.forEach(filter => filter.addEventListener('click', e => { e.preventDefault(); setCategory(filter.dataset.category); toggleDrawer(false); }));
                DOMElements.categoryTabs.forEach(tab => tab.addEventListener('click', () => setCategory(tab.dataset.category)));
                if(DOMElements.fontSelect) DOMElements.fontSelect.addEventListener('change', (e) => applyFont(e.target.value));
                DOMElements.expandArrow.addEventListener('click', () => DOMElements.expandableDescription.classList.toggle('expanded'));
                DOMElements.screenshotsContainer.addEventListener('click', e => { if(e.target.tagName === 'IMG') openScreenshotViewer(e.target.dataset.index); });
                DOMElements.screenshotNavPrev.addEventListener('click', () => navigateScreenshots(-1));
                DOMElements.screenshotNavNext.addEventListener('click', () => navigateScreenshots(1));
                DOMElements.ratingStars.forEach(star => star.addEventListener('click', handleRatingStarClick));
                DOMElements.commentForm.addEventListener('submit', handleCommentSubmit);
                DOMElements.downloadBtn.addEventListener('click', handleDownload);
                DOMElements.shareBtn.addEventListener('click', handleShare); // Event listener for the new share button
                DOMElements.appSearchInput.addEventListener('input', (e) => { appState.searchQuery = e.target.value; processAndDisplayApps(); });
                DOMElements.uploadAppBtn.addEventListener('click', () => { resetUserAppForm(); navigate('upload-edit-screen'); });
                DOMElements.userAppLogoInput.addEventListener('change', e => { DOMElements.userLogoFileName.textContent = e.target.files.length ? e.target.files[0].name : 'Click to select a logo'; });
                DOMElements.userAppScreenshotsInput.addEventListener('change', e => { appState.selectedScreenshots = [...appState.selectedScreenshots, ...Array.from(e.target.files)]; DOMElements.userScreenshotsFileList.textContent = `${appState.selectedScreenshots.length} file(s) selected`; });
            }
            
            updateUIForUser(user);
            setupEventListeners();
            fetchApps();
            applyInitialSettings();
            
            const initialPage = window.location.hash ? window.location.hash.substring(1) : 'home-screen';
            navigate(initialPage, false, true);
        }
    });
</script>
</body>
                                                                                                                                                                                                 </html>
